#!/usr/bin/env bash

# ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; #

#################################### DEFINING LIBRARY FUNCTIONS ###################################

#### CHECKING FOR IDENTIFIANTS

## EFFECTIVE USER IDENTIFIANTS CHECKING

# Checking if the current effective UID (EUID) is not equal to 0 (root user's EUID)

# Required functions and files :
#   - HandleErrors      -> Bash-Utils/src/functions/Headers.lib
function CheckRootEUID
{
    if [ "$EUID" -ne 0 ]; then
        HandleErrors "1" "YOU NEED ROOT USER'S PRIVILEGES TO PERFORM THIS ACTION !" "Please launch your script with super-user privileges." "$(basename "${BASH_SOURCE[0]}")" "${FUNCNAME[0]}" "$LINENO"
    fi
}


# /////////////////////////////////////////////////////////////////////////////////////////////// #

#### TEXT CHECKING

## COLOR CHECKINGS

# Checking line colors

# I'm not sure if i'll keep this function.
function CheckLineColor
{
    #***** Parameters *****
    p_colorCode=$1

    #***** Code *****
    if [ "$p_colorCode" != "$(tput sgr0)" ]; then
        echo "$(tput setaf 196)Error :$(tput sgr0) the $(tput setaf "$COL_CYAN")tput$(tput sgr0) command's option is not $(tput setaf "$COL_CYAN")sgr0$(tput sgr0)."; echo
        exit 1
    elif [ "$p_colorCode" -lt 0 ] && [ "$p_colorCode" -gt 0 ]; then
        echo "$(tput setaf 196)Error :$(tput sgr0) the $(tput setaf "$COL_CYAN")tput setaf$(tput sgr0) command's value is incorrect."; echo
        exit 1
    else
        echo "$(tput setaf 196)Error :$(tput sgr0) the $(tput setaf "$COL_CYAN")tput$(tput sgr0) command's option is incorrect."; echo
        exit 1
    fi
}

# Checking the " variable's value.
function CheckTextColor
{
    #***** Parameters *****
    p_option=$1
    p_colorCode=$2
    
    #***** Variables *****
    v_colCyan="$(tput setaf "$COL_CYAN")"
    v_colRed="$(tput setaf "$COL_RED")"
    v_string="$(tput setaf "$COL_RED")IN $v_colCyan$(basename "${BASH_SOURCE[0]}")$v_colRed, FUNCTION $v_colCyan${FUNCNAME[0]}$v_colRed --> Error :"
    v_colReset="$(tput sgr0)"

    #***** Code *****
    # Spacing the conditions to make the code cleaner.
    if [ -n "$p_option" ]; then

        if [ "$p_option" = "setaf" ] ; then

            if [[ "$p_colorCode" =~ ^([0-9]+\.?|[0-9]*\.[0-9]+)$ ]]; then

                if [ "$p_colorCode" -lt 0 ] || [ "$p_colorCode" -gt 255 ]; then

                    echo "$v_string the$v_colCyan tput setaf$v_colRed command's value is incorrect." >&2

                    echo "The$v_colCyan tput setaf$v_colRed option's value range is $v_colCyan 0 - 255 $v_colReset" >&2

                    echo >&2; ExitSourced
                fi
    
            else
                echo "$v_string the$v_colCyan tput setaf$v_colRed option's value is not a number.$v_colReset" >&2; echo >&2; ExitSourced
            fi

        elif [ "$p_option" != "sgr0" ]; then
            echo "$v_string the$v_colCyan tput$v_colRed command's option is incorrect.$v_colReset" >&2; echo >&2; ExitSourced
        fi
        
    else
        echo "$v_string no value passed as$v_colCyan tput$v_colRed command's option argument$v_colReset" >&2; echo >&2; ExitSourced
    fi
}

# -----------------------------------------------


# /////////////////////////////////////////////////////////////////////////////////////////////// #

#### VARIABLES VALUES CHECKING

## NUMBER VALUES

# Checking floating value.
function IsFloat
{
    #***** Parameters *****
    value=$1

    #***** Code *****
    if [[ "$value" =~ ^[+-]?[0-9]+\.?[0-9]*$ ]]; then
        return 0
    fi
}

# Checking floating and integer value.
function IsFloatInt
{
    #***** Parameters *****
    value=$1

    #***** Code *****
    if [[ "$value" =~ ^([0-9]+\.?|[0-9]*\.[0-9]+)$ ]]; then
        return 0
    fi
}

# Checking integer value.
function IsInt
{
    #***** Parameters *****
    value=$1

    #***** Code *****
    if [[ "$value" =~ ^[+-]?[0-9]+$ ]]; then
        return 0
    fi
}

# -----------------------------------------------

## STRING VALUES

# Checking string value (no number allowed)
function IsString
{
    #***** Parameters *****
    value=$1

    #***** Code *****
    # Checking if the value is a floating number or an integer.
    if [ "$value" != $(IsFloat "$value") ] && [ "$value" != "$(IsFloatInt "$value")" ] && [ "$value" != "$(isInt "$value")" ]; then
        return 0
    fi
}

# -----------------------------------------------

# /////////////////////////////////////////////////////////////////////////////////////////////// #

#### PATHS CHECKING

## FILE PATHS CHECKING

# Checking for "$PROJECT_LOG_PATH"

# Required functions and files :
function CheckProjectLogPath
{
    if [ -z "$PROJECT_LOG_PATH" ]; then
        echo "$(tput setaf "$COL_RED") Error : no path provided into the $(tput setaf "$COL_CYAN")PROJECT_LOG_PATH$(tput setaf "$COL_RED") variable.$(tput sgr0)" >&2
        echo >&2; ExitSourced
    elif [ ! -f "$PROJECT_LOG_PATH" ]; then
        echo "$(tput setaf "$COL_RED") Error : incorrect path provided into the $(tput setaf "$COL_CYAN")PROJECT_LOG_PATH$(tput setaf "$COL_RED") variable.$(tput sgr0)" >&2
        echo >&2; ExitSourced
    fi
}

# Checking for project's log file's status, then write
function CheckProjectLogStatus
{
    #***** Parameters *****
    p_string=$1
    p_option=$2     # "echo" command options

    #**** Code *****
    CheckSTAT_LOG
    CheckSTAT_LOG_REDIRECT
    CheckProjectLogPath
    CheckSTAT_TIME_HEADER
    CheckSTAT_TIME_LINE
    CheckSTAT_TIME_TXT
    
    # If the text is redirected towars the log path, it's better to put every timer status variables values to '0'.
    if [ "$STAT_LOG_REDIRECT" = "true" ]; then
        if [ "$STAT_LOG_REDIRECT" = "log" ] && [ "$STAT_TIME_HEADER" -gt 0 ] || \
        [ "$STAT_TIME_LINE" -gt 0 ] || [ "$STAT_TIME_TXT" -gt 0 ]; then

            # Backup the old values to restore them when the log processing will be done.
            OLD_STAT_TIME_HEADER="$STAT_TIME_HEADER"
            OLD_STAT_TIME_LINE="$STAT_TIME_LINE"
            OLD_STAT_TIME_TXT="$STAT_TIME_TXT"
            
            STAT_TIME_HEADER="0"
            STAT_TIME_LINE="0"
            STAT_TIME_TXT="0"
        fi
    fi

    if [ "$p_option" = "-e" ]; then
        if [ -f "$PROJECT_LOG_PATH" ] && [ "$PROJECT_STATUS_LOG" = "true" ] && [ -n "$STAT_LOG_REDIRECT" ]; then
            if [ "$STAT_LOG_REDIRECT" = "log" ]; then
                echo -e "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            elif [ "$STAT_LOG_REDIRECT" = "tee" ]; then
                echo -e "$p_string"
                echo -e "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            fi
        else
            echo -e "$p_string"
        fi
    elif [ "$p_option" = "-n" ]; then
        if [ -f "$PROJECT_LOG_PATH" ] && [ "$PROJECT_STATUS_LOG" = "true" ] && [ -n "$STAT_LOG_REDIRECT" ]; then
            if [ "$STAT_LOG_REDIRECT" = "log" ]; then
                echo -n "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            elif [ "$STAT_LOG_REDIRECT" = "tee" ]; then
                echo -n "$p_string"
                echo -n "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            fi
        else
            echo -n "$p_string"
        fi
    elif [ "$p_option" = "-ne" ]; then
        if [ -f "$PROJECT_LOG_PATH" ] && [ "$PROJECT_STATUS_LOG" = "true" ] && [ -n "$STAT_LOG_REDIRECT" ]; then
            if [ "$STAT_LOG_REDIRECT" = "log" ]; then
                echo -ne "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            elif [ "$STAT_LOG_REDIRECT" = "tee" ]; then
                echo -ne "$p_string"
                echo -ne "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            fi
        else
            echo -ne "$p_string"
        fi
    else
        if [ -f "$PROJECT_LOG_PATH" ] && [ "$PROJECT_STATUS_LOG" = "true" ] && [ -n "$STAT_LOG_REDIRECT" ]; then
            if [ "$STAT_LOG_REDIRECT" = "log" ]; then
                echo "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            elif [ "$STAT_LOG_REDIRECT" = "tee" ]; then
                echo "$p_string"
                echo "[$TIME_DATE] $p_string" >> "$PROJECT_LOG_PATH" || \
                    { echo "$(ColorChar "setaf" "$COL_RED") Unable to write into the $(DechoE "$PROJECT_LOG_PATH") file.$(ColorChar "sgr0")" >&2; echo >&2; ExitSourced; }
            fi
        else
            echo "$p_string"
        fi
    fi
    
    # Restore timer status variables old values if they were modified because of the redirection to the log file only.
    if [ "$STAT_LOG_REDIRECT" = "true" ]; then
        if [ "$STAT_LOG_REDIRECT" = "log" ] && [ "$STAT_TIME_HEADER" -eq 0 ] || \
            [ "$STAT_TIME_LINE" -eq 0 ] || [ "$STAT_TIME_TXT" -eq 0 ]; then
        
            # Backup the old values to restore them when the log processing will be done.
            STAT_TIME_HEADER="$OLD_STAT_TIME_HEADER"
            STAT_TIME_LINE="$OLD_STAT_TIME_LINE"
            STAT_TIME_TXT="$OLD_STAT_TIME_TXT"
            
            echo "$STAT_TIME_HEADER"
            echo "$STAT_TIME_LINE"
            echo "$STAT_TIME_TXT"
            
            # Checking if the correct values were reassignated.
            CheckSTAT_TIME_HEADER
            CheckSTAT_TIME_LINE
            CheckSTAT_TIME_TXT
        fi
    fi
}

# -----------------------------------------------

## DIRECTORIES PATHS CHECKING

# 

# -----------------------------------------------


# /////////////////////////////////////////////////////////////////////////////////////////////// #

#### ERRORS HANDLING FUNCTIONS

## EXIT HANDLING

# Handling exit command from sourced files, as it's impossible to properly exit the script from these.
function ExitSourced { kill "$$"; }

# -----------------------------------------------

## SCRIPT'S ERRORS HANDLING

# Handling command outputs.
function HandleErrors
{
	#***** Paramètres *****
	p_returnCode=$1     # Return code of the last command executed. If you didn't launched any command before calling this function, you can pass any number different of '0' as first argument.
	p_errorString=$2    # Chaîne de caractères du type d'erreur à afficher.
	p_adviceString=$3   # Chaîne de caractères affichants un conseil pour orienter l'utilisateur vers la meilleure solution en cas de problème.
	p_file=$4            # The name of the file where the error occured.
	p_function=$5        # The name of the function where the error occured.
	p_lineno=$6          # Ligne à laquelle le message d'erreur s'est produite.

    #***** Variables *****
    # Echoing the line breaks according to the "STAT_LOG_REDIRECT" status variable's value (processed a few lines down).
    v_echo=""
    
    v_headerString="IN $(DechoE "$p_file"), FUNCTION $(DechoE "$p_function"), LINE $(DechoE "$p_lineno") -->"

	# ***** Code *****
	CheckSTAT_ERROR
	
	# If the text was redirected to the log file, it will also be redirected to the terminal.
	CheckSTAT_LOG_REDIRECT; if [ "$STAT_LOG_REDIRECT" = "log" ]; then
        STAT_LOG_REDIRECT="tee"
        v_echo="$(echo >&2 | tee -a "$PROJECT_LOG_PATH")"
    else
        v_echo="$(Newline)"
	fi

	if [ "$p_returnCode" -eq 0 ]; then
        return
    else
        if [ -n "$STAT_ERROR" ] && [ "$STAT_ERROR" = "fatal" ]; then
            HeaderRed "$v_headerString FATAL ERROR : $(DechoE "${p_errorString^^}")" >&2

            if [ -z "$p_adviceString" ]; then
                EchoError "No advice to give."
                echo "$v_echo"
            else
                EchoError "Advice : $p_adviceString"
                echo "$v_echo"
            fi

            EchoError "Stopping the execution of $(DechoE "$(basename "$0")")."
            echo "$v_echo"

            exit 1

        elif [ -z "$STAT_ERROR" ]; then
            HeaderRed "$v_headerString FATAL ERROR : $(DechoE "${p_errorString^^}")"

            if [ -z "$p_adviceString" ]; then
                EchoError "No advice to give."
                echo "$v_echo"
            else
                EchoError "Advice : $p_adviceString"
                echo "$v_echo"
            fi
            
            KbInputYesNo "Do you want to stop the execution of $(DechoE "$(basename "$0")") ? $(DechoN "(yes/no)")" \
                "$(echo "Aborting script execution." && exit 1)" \
                "Resuming script execution." >&2
        fi
    fi
}

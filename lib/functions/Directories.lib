#!/usr/bin/env bash

# /////////////////////////////////////////////////////////////////////////////////////////////// #

#### DIRECTORIES FUNCTIONS

## PROCESSING FUNCTIONS

# Separate processing steps displays from the rest of the main script with a line.

# Featured functions and files from the "functions" folder :
#   - DrawLine      -> Headers.lib
#   - HandleErrors  -> Headers.lib
function ProcessingDir
{
    #***** Parameters *****
    function=$1
    
    #***** Variables *****
    char='"'
    
    #***** Code *****
    # On commence par dessiner la première ligne du bloc.
	sleep "$PROJECT_STATUS_SLEEP_LINE"
    DrawLine "$COL_RESET" "$char"
    EchoNewstep "Processing the $(DechoN "$name") folder in the parent folder $(DechoN "$parent")."
    Newline
    
    if $("$function"); then
        EchoSuccess "End of processing the $(DechoS "$path/") folder."
		DrawLine "$COL_RESET" "$char"
		sleep "$PROJECT_STATUS_SLEEP_LINE"
		Newline
    else
        EchoError "End of processing the $(DechoE "$path/") folder."
		DrawLine "$COL_RESET" "$char"
		sleep "$PROJECT_STATUS_SLEEP_LINE"
		Newline
    fi
}

# -----------------------------------------------

## FOLDER CREATION FUNCTIONS

# Overwriting an existing directory's content

# Featured functions and files from the "functions" folder :
#	- EchoError			-> Echo.lib
#	- EchoNewstep		-> Echo.lib
#	- EchoSuccess		-> Echo.lib
#	- Newline			-> Echo.lib
function OverwriteDir
{
    #***** Parameters *****
    path=$1

    #***** Code *****
    EchoNewstep "A non-empty folder with exactly the same name ($(DechoN "$name")) is already in the target folder $(DechoN "$parent/")"
	EchoNewstep "Deleting the contents of the $(DechoN "$path/") folder"
	Newline
	
	# WARNING ! DO NOT MODIFY THE FOLLOWING COMMAND, UNLESS YOU KNOW EXACTLY WHAT YOU DO !!!
	# Check this link for more informations about this command --> https://github.com/koalaman/shellcheck/wiki/SC2115
    rm -rfv "${path/:?}/"*
    HandleErrors "$?" "${FUNCNAME[0]} : UNABLE TO DELETE THE CONTENT OF THE $(DechoE "$path/") FOLDER." "" ""
    EchoSuccess "Deletion of the contents of the folder $(DechoS "$path/") performed successfully"
    Newline

    return 0
}



# Folder creation AND recursively assigning read and write rights to the user.
# When this function is called, if a log file is used in the project, the output of this function must be redirected either to the terminal AND the log file (2>&1 | tee -a "$FILE_LOG_PATH"), or to the log file only (>> "$FILE_LOG_PATH") after passing all the mandatory arguments. Otherwise, leave everything blank after passing the arguments.

# Featured functions and files from the "functions" folder :
#   - Echo.sh       -> EchoErrorTimer
#   - Echo.sh       -> EchoNewstepTimer
#   - Echo.sh       -> EchoSuccessTimer
#   - Headers.sh    -> DrawLine   
#   - Headers.sh    -> HandleErrors
function Makedir
{
	#***** Parameters *****
	local parent=$1		# Emplacement depuis la racine du dossier parent du dossier à traiter.
	local name=$2		# Nom du dossier à traiter (dans son dossier parent).

	#***** Variables *****
	local path="$parent/$name"	# Chemin du dossier à traiter.
	local block_char='"'		# Caractère composant la ligne (c'est un double quote (")).

	#***** Code *****
	# Si le dossier à traiter n'existe pas, alors le script le crée.
	if [ ! -d "$path" ]; then
		EchoNewstep "Creating the $(DechoN "$name") folder in the parent folder $(DechoN "$parent/")."
		Newline

		# On crée une variable nommée "lineno". Elle enregistre la valeur de la variable globale "$LINENO", qui enregistre le numéro de la ligne dans laquelle est est appelée dans un script.
        mkdir -pv "$path"
        HandleErrors "$?" "${FUNCNAME[0]} : THE $(DechoE "$name") FOLDER CANNOT BE CREATED IN THE PARENT FOLDER $(DechoE "$parent/") !" "" ""
        EchoSuccess "The $(DechoS "$name") folder was successfully created in the $(DechoS "$parent") folder."
        Newline
        
        return 0
            # On vérifie si le dossier a bien été créé en vérifiant le code de retour de la commande "mkdir" via la fonction "HandleErrors"

    # Sinon, si le dossier à créer existe déjà dans son dossier parent ET que ce dossier contient AU MOINS un fichier ou dossier.
	elif [ -d "$path" ] && [ "$(ls -A "$path")" ]; then
        if OverwriteDir "$path"; then
            return 0
		else
            return 1
		fi

	# Sinon, si le dossier à créer existe déjà dans son dossier parent ET que ce dossier est vide.
	elif [ -d "$path" ] && [ ! "$(ls -A "$path")" ]; then
		EchoSuccess "The $(DechoS "$path/") folder already exists in the $(DechoS "$parent/") folder and is empty."
		Newline

		return 0
    fi
}

# -----------------------------------------------

## PATH PROCESSING

# Getting parent folder's without its full path.
function GetParentDirectoryName
{
    # There's no need to pass any argument to this function.
    parent="$( cd "$(dirname "$0")" >/dev/null 2>&1 \
        || { HandleErrors "1" "UNABLE TO GET THE PARENT DIRECTORY'S NAME" "Check if the provided path is correct." "$(basename "${BASH_SOURCE[0]}")" "${FUNCNAME[0]}" "$LINENO"; }; \
        pwd -P )"
    dirname="$parent"

    shopt -s extglob           # enable +(...) glob syntax
    result=${dirname%%+(/)}    # trim however many trailing slashes exist
    echo "$result"
}

# Getting parent folder's with its full path.
function GetParentDirectoryPath
{
    # There's no need to pass any argument to this function.
    parent="$( cd "$(dirname "$0")" >/dev/null 2>&1 \
        || { HandleErrors "1" "UNABLE TO GET THE PARENT DIRECTORY'S PATH" "Check if the provided path is correct." "$(basename "${BASH_SOURCE[0]}")" "${FUNCNAME}" "$LINENO"; }; \
        pwd -P )"
    dirname="$parent"

    echo "$dirname"
}

# Getting the name of a directory without its path
function GetDirectoryName
{
    dir=""
}

# Checking if the directory's sub-folders paths passed as argument exists.
function GetDirectorySubFolderPath
{
    #***** Parameters *****
    path=$1

    #***** Code *****
    if [ -z "$path" ]; then
        HandleErrors "1" "${FUNCNAME[0]} : NO PATH ARGUMENT PASSED" "" ""
    else
        if [ -d "$path" ]; then
            EchoSuccess "Got this subfolder : $(DechoS "$path")"
        else
            HandleErrors "1" "UNABLE TO GET TH : THE PATH PROVIDED FOR THE $(DechoE "$path") IS INCORRECT !" "Check if the provided path is correct." "$(basename "${BASH_SOURCE[0]}")"
        fi
    fi
}

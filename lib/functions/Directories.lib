#!/usr/bin/env bash

# ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; #

#################################### DEFINING LIBRARY FUNCTIONS ###################################

## PROCESSING FUNCTIONS

# Separate processing steps displays from the rest of the main script with a line.

# Featured functions and files from the "functions" folder :
#   - DrawLine      -> Headers.lib
#   - HandleErrors  -> Headers.lib
function ProcessingDir
{
    #***** Parameters *****
    function=$1
    
    #***** Variables *****
    char='"'
    
    #***** Code *****
    # On commence par dessiner la première ligne du bloc.
	sleep "$PROJECT_STATUS_SLEEP_LINE"
    DrawLine "$COL_RESET" "$char"
    EchoNewstep "Processing the $(DechoN "$name") folder in the parent folder $(DechoN "$parent")."
    Newline
    
    if $("$function"); then
        EchoSuccess "End of processing the $(DechoS "$path/") folder."
		DrawLine "$COL_RESET" "$char"
		sleep "$PROJECT_STATUS_SLEEP_LINE"
		Newline
    else
        EchoError "End of processing the $(DechoE "$path/") folder."
		DrawLine "$COL_RESET" "$char"
		sleep "$PROJECT_STATUS_SLEEP_LINE"
		Newline
    fi
}

# Overwriting an existing directory's content

# Featured functions and files from the "functions" folder :
#	- EchoError			-> Echo.lib
#	- EchoNewstep		-> Echo.lib
#	- EchoSuccess		-> Echo.lib
#	- Newline			-> Echo.lib
function OverwriteDir
{
    #***** Parameters *****
    path=$1

    #***** Code *****
    EchoNewstep "A non-empty folder with exactly the same name ($(DechoN "$name")) is already in the target folder $(DechoN "$parent/")"
	EchoNewstep "Deleting the contents of the $(DechoN "$path/") folder"
	Newline
	
	# WARNING ! DO NOT MODIFY THE FOLLOWING COMMAND, UNLESS YOU KNOW EXACTLY WHAT YOU DO !!!
	# Check this link for more informations about this command --> https://github.com/koalaman/shellcheck/wiki/SC2115
    rm -rfv "${path/:?}/"*
    HandleErrors "$?" "Unable to delete the contents of the $(DechoE "$path/") folder." "" ""
    EchoSuccess "Deletion of the contents of the folder $(DechoS "$path/") performed successfully"
    Newline

    return 0
}



# Folder creation AND recursively assigning read and write rights to the user.
# When this function is called, if a log file is used in the project, the output of this function must be redirected either to the terminal AND the log file (2>&1 | tee -a "$FILE_LOG_PATH"), or to the log file only (>> "$FILE_LOG_PATH") after passing all the mandatory arguments. Otherwise, leave everything blank after passing the arguments.

# Featured functions and files from the "functions" folder :
#   - Echo.sh       -> EchoErrorTimer
#   - Echo.sh       -> EchoNewstepTimer
#   - Echo.sh       -> EchoSuccessTimer
#   - Headers.sh    -> DrawLine   
#   - Headers.sh    -> HandleErrors
function Makedir
{
	#***** Parameters *****
	local parent=$1		# Emplacement depuis la racine du dossier parent du dossier à traiter.
	local name=$2		# Nom du dossier à traiter (dans son dossier parent).

	#***** Variables *****
	local path="$parent/$name"	# Chemin du dossier à traiter.
	local block_char='"'		# Caractère composant la ligne (c'est un double quote (")).

	#***** Code *****
	# Si le dossier à traiter n'existe pas, alors le script le crée.
	if [ ! -d "$path" ]; then
		EchoNewstep "Creating the $(DechoN "$name") folder in the parent folder $(DechoN "$parent/")."
		Newline

		# On crée une variable nommée "lineno". Elle enregistre la valeur de la variable globale "$LINENO", qui enregistre le numéro de la ligne dans laquelle est est appelée dans un script.
        mkdir -pv "$path"
        HandleErrors "$?" "THE $(DechoE "$name") FOLDER CANNOT BE CREATED IN THE PARENT FOLDER $(DechoE "$parent/")." "$lineno"
        EchoSuccess "The $(DechoS "$name") folder was successfully created in the $(DechoS "$parent") folder."
        Newline
        
        return 0
            # On vérifie si le dossier a bien été créé en vérifiant le code de retour de la commande "mkdir" via la fonction "HandleErrors"

    # Sinon, si le dossier à créer existe déjà dans son dossier parent ET que ce dossier contient AU MOINS un fichier ou dossier.
	elif [ -d "$path" ] && [ "$(ls -A "$path")" ]; then
        if OverwriteDir "$path"; then
            return 0
		else
            return 1
		fi

	# Sinon, si le dossier à créer existe déjà dans son dossier parent ET que ce dossier est vide.
	elif [ -d "$path" ] && [ ! "$(ls -A "$path")" ]; then
		EchoSuccess "The $(DechoS "$path/") folder already exists in the $(DechoS "$parent/") folder and is empty."
		Newline

		return 0
    fi
}

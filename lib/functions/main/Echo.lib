#!/usr/bin/env bash

# ----------------------
# SCRIPT'S INFORMATIONS

# Name          : Echo.lib
# Module        : Main
# Description   : (Colored) text display functions.
# Author(s)     : Dimitri Obeid
# Version       : 

# ----------------------
# SHELLCHECK GLOBAL DISABLER :

# Add a coma after each warning code to disable multiple warnings at one go.
# DO NOT PUT A COMA AFTER A SHELLCHECK CODE IF THERE'S NO OTHER SHELLCHECK CODE FOLLOWING IT, OR ELSE SHELLCHECK WILL RETURN ERRORS DURING THE DEBUGGING PROCESS !!!

# shellcheck disable=SC2154

# ----------------------
# DO NOT EXECUTE THIS SCRIPT DIRECTLY, instead, just source it by calling the "$__BU_MAIN_FUNCTIONS_FILES_PATH" array in the initializer file.

# /////////////////////////////////////////////////////////////////////////////////////////////// #

# Preventing the direct execution of this file, as this script is not meant to be directly executed, but sourced.
if [ "${0##*/}" == "${BASH_SOURCE[0]##*/}" ]; then
    echo -e "WARNING !" >&2; echo >&2
    echo -e "This shell script (${BASH_SOURCE[0]}) is not meant to be executed directly !" >&2
    echo -e "Use this script only by sourcing it in your project script." >&2; echo >&2

    exit 1
fi

# ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; #

#################################### DEFINING LIBRARY FUNCTIONS ###################################

#### PRINTING FORMATTED STRINGS

## DEBUGGING AND HANDLING TEXT DISPLAY ERRORS

# Print void lines before and after calling a header.
function __EchoVoid()
{
    printf "
    
    
    
    
    
    
    
    
    
    " > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH"
}

# "Echo<...>()" functions debug output for a better view during a debug process.
# It's better to also execute the project's script with the "bash - x $project_name" command, instead of the "./$project_name" way.
function __EchoOutput()
{
	#***** Parameters *****
	local p_string=$1		# String to display.
	local p_context=$2		# Begin or end of the debug process.
	local p_type=$3			# Type of message (error 'E', newstep 'N', success 'S' or warning 'W').

	#***** Code *****
	if [ "$__BU_MAIN_STAT_DEBUG" = 'false' ]; then return 0

	elif [ "$__BU_MAIN_STAT_DEBUG" = "true" ]; then
		CheckProjectRelatedFile "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PARENT" "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_NAME" "f" || { HandleSmallErrors 'E' "$(DechoHighlight "${FUNCNAME[0]}") --> Unable to create the $(DechoHighlight "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_NAME") debug log file" 'E' "CPLS"; exit 1; }

        if [ "$p_context" = "begin" ]; then
            __EchoVoid

            if [ "${p_type^^}" = "E" ]; then
                echo -e "$(HeaderError "BEGIN DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH"	|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'm' ]; then
                echo -e "$(Header "BEGIN DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 		|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'N' ]; then
                echo -e "$(HeaderNewstep "BEGIN DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 	|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'S' ]; then
                echo -e "$(HeaderSuccess "BEGIN DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 	|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'W' ]; then
                echo -e "$(HeaderWarning "BEGIN DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 	|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            fi

            return 0

        elif [ "$p_context" = "end" ]; then
            if [ "${p_type^^}" = "E" ]; then
                echo -e "$(HeaderError "END DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 		|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'm' ]; then
                echo -e "$(Header "END DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 			|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'N' ]; then
                echo -e "$(HeaderNewstep "END DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 	|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'S' ]; then
                echo -e "$(HeaderSuccess "END DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH"	|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            elif [ "${p_type^^}" = 'W' ]; then
                echo -e "$(HeaderWarning "END DEBUGGING TEXT : $p_string")" > "$__BU_MAIN_PROJECT_ECHO_OUTPUT_FILE_PATH" 	|| { HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}")" 'W' ''; return 1; }
            fi

            __EchoVoid; return 0
        fi
    fi
}

# Failsafe if any "Echo<...>()" function has to be called in the "CheckProjectLogStatus()" function.
function __EchoCPLS()
{
    #***** Parameters *****
    p_string=$1
    p_option=$2

    shift 2; pa_extraArgs=("$@")

    #***** Code *****
    for val in "${pa_extraArgs[@]}"; do
        if [ "$val" = 'nodate' ]; then 
            case "$p_option" in
                '-n' | 'n')
                    if CheckIsInitializing; then
                        InitializerAddInitStrArrayVal "$p_string" 'n' || return 1
                    else
                        echo -ne "$p_string"
                    fi
                    ;;
                '' | *)
                    if CheckIsInitializing; then
                        InitializerAddInitStrArrayVal "$p_string" || return 1
                    else
                        echo -e "$p_string"
                    fi
                    ;;
            esac
        elif [ -z "$val" ]; then
            case "$p_option" in
                '-n' | 'n')
                    if CheckIsInitializing; then
                        InitializerAddInitStrArrayVal "$p_string" 'n' || return 1
                    else
                        echo -ne "$__BU_MAIN_TIME_DATE_DISPLAY $p_string"
                    fi
                    ;;
                '' | *)
                    if CheckIsInitializing; then
                        InitializerAddInitStrArrayVal "$p_string" || return 1
                    else
                        echo -e "$__BU_MAIN_TIME_DATE_DISPLAY $p_string"
                    fi
                    ;;
            esac
        else
            case "$p_option" in
                '-n' | 'n')
                    if CheckIsInitializing; then
                        InitializerAddInitStrArrayVal "$p_string" 'n' || return 1
                    else
                        echo -ne "$__BU_MAIN_TIME_DATE_DISPLAY $p_string"
                    fi
                    ;;
                '' | *)
                    if CheckIsInitializing; then
                        InitializerAddInitStrArrayVal "$p_string" || return 1
                    else
                        echo -e "$__BU_MAIN_TIME_DATE_DISPLAY $p_string"
                    fi
                    ;;
            esac
        fi

        sleep "$__BU_MAIN_STAT_TIME_TXT"
    done

    return 0
}

# --------------------------------------------

## DISPLAYING A COLORED MESSAGE WITH A PAUSE TIME DEPENDING ON THE "$__BU_MAIN_STAT_TIME_TXT" status variable.

# Error message

# Usage :
#	EchoError "<Text to write>" "<optional echo argument>" "<Any extra argument supported by the CheckProjectLogStatus() function>"

# Featured functions and files from the "functions" folder :
#   - CheckProjectLogStatus     --> Checkings.lib
function EchoError()
{
    #***** Parameters *****
    local p_string=$1
    local p_option=$2; shift 2

    local pa_extraArgs=("$@")

    #***** Code *****
    if ! CheckEcho || ! CheckIsInitializing; then
        __EchoOutput "$p_string" 'begin' 'E' || return 1
        CheckProjectLogStatus "${__BU_MAIN_COLOR_ERROR}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'E' || return 1

    # Failsafe if any "Echo<...>()" function has to be called in the "CheckProjectLogStatus()" function.
    else
        __EchoOutput "$p_string" 'begin' 'E' || return 1
        __EchoCPLS "${__BU_MAIN_COLOR_ERROR}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'E' || return 1
    fi

    sleep "$__BU_MAIN_STAT_TIME_TXT"; return 0
}

# Normal message (without any extra color), with redirection checking.

# Usage :
#	EchoError "<Text to write>" "<optional echo argument>" "<Any extra argument supported by the CheckProjectLogStatus() function>"

# Featured functions and files from the "functions" folder :
#   - CheckProjectLogStatus     --> Checkings.lib
function EchoMsg()
{
    #***** Parameters *****
    local p_string=$1
    local p_option=$2;
    shift 2

    local pa_extraArgs=("$@")

    #***** Code *****
    if ! CheckEcho; then
        __EchoOutput "$p_string" 'begin' 'm' || return 1
        CheckProjectLogStatus "$p_string" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'm' || return 1

    # Failsafe if any "Echo<...>()" function has to be called in the "CheckProjectLogStatus()" function.
    else
        __EchoOutput "$p_string" 'begin' 'm' || return 1
        __EchoCPLS "$p_string" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'm' || return 1
    fi

    sleep "$__BU_MAIN_STAT_TIME_TXT"; return 0
}

# New sub-step message

# Usage :
#	EchoError "<Text to write>" "<optional echo argument>" "<Any extra argument supported by the CheckProjectLogStatus() function>"

# Featured functions and files from the "functions" folder :
#   - CheckProjectLogStatus     --> Checkings.lib
function EchoNewstep()
{
    #***** Parameters *****
    local p_string=$1
    local p_option=$2;
    shift 2

    local pa_extraArgs=("$@")

    #***** Code *****
    if ! CheckEcho; then
        __EchoOutput "$p_string" 'begin' 'N' || return 1
        CheckProjectLogStatus "${__BU_MAIN_COLOR_NEWSTEP}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'N' || return 1

    # Failsafe if any "Echo<...>()" function has to be called in the "CheckProjectLogStatus()" function.
    else
        __EchoOutput "$p_string" 'begin' 'N' || return 1
        __EchoCPLS "${__BU_MAIN_COLOR_NEWSTEP}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'N' || return 1
    fi

    sleep "$__BU_MAIN_STAT_TIME_TXT"; return 0
}

# Read input values

# Usage :
#	EchoError "<Text to write>" "<optional echo argument>" "<Any extra argument supported by the CheckProjectLogStatus() function>"

# Featured functions and files from the "functions" folder :
#	- CheckProjectLogStatus		--> Checkings.lib
function EchoRead()
{
	#***** Parameters *****
	local p_string=$1      # User's keyboard input.
	
	#***** Code *****
	if [ -f "$__BU_MAIN_PROJECT_LOG_FILE_PATH" ] && [ "$__BU_MAIN_STAT_LOG" = "true" ] && [ -n "$__BU_MAIN_STAT_LOG_REDIRECT" ]; then
		echo -e "Keyboard input value : $(DechoHighlight "$p_string")" >> "$__BU_MAIN_PROJECT_LOG_FILE_PATH" || { HandleSmallErrors '' "" '' ""; return 1; }
	fi; return 0
}

# Success message

# Usage :
#	EchoError "<Text to write>" "<optional echo argument>" "<Any extra argument supported by the CheckProjectLogStatus() function>"

# Featured functions and files from the "functions" folder :
#   - CheckProjectLogStatus     --> Checkings.lib
function EchoSuccess()
{
    #***** Parameters *****
    local p_string=$1
    local p_option=$2;
    shift 2

    local pa_extraArgs=("$@")

    #***** Code *****
    if ! CheckEcho; then
        __EchoOutput "$p_string" 'begin' 'S' || return 1
        CheckProjectLogStatus "${__BU_MAIN_COLOR_SUCCESS}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'S' || return 1

    # Failsafe if any "Echo<...>()" function has to be called in the "CheckProjectLogStatus()" function.
    else
        __EchoOutput "$p_string" 'begin' 'S' || return 1
        __EchoCPLS "${__BU_MAIN_COLOR_SUCCESS}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'S' || return 1
    fi

    sleep "$__BU_MAIN_STAT_TIME_TXT"; return 0
}

# Warning message

# Usage :
#	EchoError "<Text to write>" "<optional echo argument>" "<Any extra argument supported by the CheckProjectLogStatus() function>"

# Featured functions and files from the "functions" folder :
#   - CheckProjectLogStatus     --> Checkings.lib
function EchoWarning()
{
    #***** Parameters *****
    local p_string=$1
    local p_option=$2;
    shift 2

    local pa_extraArgs=("$@")

    #***** Code *****
    if ! CheckEcho; then
        __EchoOutput "$p_string" 'begin' 'W' || return 1
        CheckProjectLogStatus "${__BU_MAIN_COLOR_WARNING}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'W' || return 1

    # Failsafe if any "Echo<...>()" function has to be called in the "CheckProjectLogStatus()" function.
    else
        __EchoOutput "$p_string" 'begin' 'W' || return 1
        __EchoCPLS "${__BU_MAIN_COLOR_WARNING}$__BU_MAIN_TXT_PRINT_TAB$__BU_MAIN_TXT_PRINT_TAB $p_string${__BU_MAIN_COLOR_RESET}" "$p_option" "${pa_extraArgs[@]}" || return 1

        __EchoOutput "$p_string" 'end' 'W' || return 1
    fi

    sleep "$__BU_MAIN_STAT_TIME_TXT"; return 0
}

# -----------------------------------------------

## TEXT FORMATTING

# Keep the same text format between lowercased or uppercased text printed by a formatting text function ("ToLowercase()" OR "ToUppercase()") or a parameter expansion.
# This function is planned to be used between force-uppered/lowered text, to keep the original text formatting of the wanted string excerpt.
function KeepFormatting()
{
	#***** Parameters *****
	p_string=$1            # String to display.
	p_old_formatting=$2    # Former tectxt formatting.

	#***** Code *****
# 	echo -ne &>/dev/null; echo -ne "$p_string"
# 
# 	if [ "${p_old_formatting,,}" = 'l' ]; then
#         echo -ne "$(ToLowercase "$p_string")"
# 	elif [ "${p_old_formatting^^}" = 'U' ]; then
#         echo -ne "$(ToUppercase "$p_string")"
# 	else
#         echo -ne "<<|| No reformatting precised in the $(ToLowercase "${FUNCNAME[0]}()") function ||>>"
# 	fi

	return 0
}

# Print a lowercased text.

# Usage :
#	ToLowercase "<Text to write>"
function ToLowercase()
{
	#***** Parameters *****
	p_string=$1

	#***** Code *****
	echo -e "$p_string" | tr '[:upper:]' '[:lower:]'; return 0
}

# Print an uppercased text.

# Usage :
#	ToUppercase "<Text to write>"
function ToUppercase()
{
	#***** Parameters *****
	p_string=$1

	#***** Code *****
	echo -e "$p_string" | tr '[:lower:]' '[:upper:]'; return 0
}

# -----------------------------------------------



# /////////////////////////////////////////////////////////////////////////////////////////////// #

#### LINE BREAKS

## LINE BREAKS ACCORDING TO THE "$MAIN_SCRIPT_LOG" VARIABLE VALUE

# Redirecting the output of the "echo" command

# Featured functions and files from the "functions" folder :
#   - CheckProjectLogStatus     --> Checkings.lib
#	- HandleErrors				--> Checkings.lib
function Newline()
{
    #***** Parameters *****
    local number=$1

    #***** Code *****

    if [ -n "$number" ]; then
        if ! IsInt "$number"; then
            EchoMsg "" "" "nodate"
            HandleSmallErrors 'W' "$(DechoHighlight "${FUNCNAME[0]}()") --> Warning : the number of line breaks must be an integer" 'R'
            EchoMsg "" "" "nodate"
        else
            # Doing X line breaks according to the number passed as argument.
            for ((i=0; i<number; i++)); do
                EchoMsg "" "" "nodate"
            done
        fi
    else
        EchoMsg "" "" "nodate"
    fi

    return 0
}

#!/usr/bin/env bash

# Preventing the direct execution of this file, as this script is not meant to be directly executed, but sourced.
if [ "${0##*/}" == "${BASH_SOURCE[0]##*/}" ]; then
    echo -e "WARNING !" >&2; echo >&2
    echo -e "This shell script (${BASH_SOURCE[0]}) is not meant to be executed directly !" >&2
    echo -e "Use this script only by sourcing it in your project script." >&2; echo >&2

    exit 1
fi

# ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; #

#################################### DEFINING LIBRARY FUNCTIONS ###################################

#### VARIABLES VALUES CHECKING

## HANDLINGS

# Easy writing text function.
function ConfEcho()
{
    #***** Parameters *****
    local p_file=$1;
    local p_lineno=$2;
    local p_badVal=$3;
    local p_varVal=$4

    # Shifting the same number of time as the former arguments number
    # to avoid including these arguments values in the allowed values array.
    shift 4
    local pa_correctValues=("$@")

    #***** Variables *****
    local i=0

    #***** Code *****
    echo >&2; echo -n "${__BU_COLOR_ERROR}$__BU_TXT_TAB$__BU_TXT_TAB In ${__BU_COLOR_HIGHLIGHT}$p_file${__BU_COLOR_ERROR}, line ${__BU_COLOR_HIGHLIGHT}$p_lineno${__BU_COLOR_ERROR} --> " >&2
    echo -e "Error : the ${__BU_COLOR_HIGHLIGHT}$p_varVal${__BU_COLOR_ERROR} variable's value is incorrect.${__BU_COLOR_RESET}" >&2

    if [ -z "$p_badVal" ]; then
        echo >&2; echo -e "${__BU_COLOR_ERROR}$__BU_TXT_TAB$__BU_TXT_TAB Bad value :${__BU_COLOR_YELLOW} An empty string.${__BU_COLOR_RESET}" >&2
    else
        echo >&2; echo -e "${__BU_COLOR_ERROR}$__BU_TXT_TAB$__BU_TXT_TAB Bad value : ${__BU_COLOR_HIGHLIGHT}$p_badVal.${__BU_COLOR_RESET}" >&2
    fi

    echo >&2; echo -e "${__BU_COLOR_ERROR}$__BU_TXT_TAB$__BU_TXT_TAB The allowed values are :${__BU_COLOR_RESET}" >&2

    # Displaying the list of every allowed arguments.
    for val in "${pa_correctValues[@]}"; do
        i=$(( i+1 ))

        # If an empty argument is allowed.
        if [ -z "$val" ]; then
            echo -e "${__BU_COLOR_ERROR}$i/${#pa_correctValues[@]}  --> ${__BU_COLOR_ORANGE}An empty argument.${__BU_COLOR_RESET}" >&2
        else
            echo -e "${__BU_COLOR_ERROR}$i/${#pa_correctValues[@]}  --> ${__BU_COLOR_HIGHLIGHT}$val${__BU_COLOR_RESET}" >&2
        fi
    done

    echo >&2; ExitError 1
}

# -----------------------------------------------

## CHECKINGS

# Check the "$__STAT_CPLS" status variable's value.
function CheckSTAT_CPLS()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("true" "false")

    #***** Code *****
    if [ "$__STAT_CPLS" != "true" ] && [ "$__STAT_CPLS" != "false" ]; then
        ConfEcho "$p_file" "$p_lineno" "$__STAT_CPLS" "__STAT_CPLS" "${pa_correctValues[@]}"
    fi
}

# Checking the "$__STAT_DEBUG" status variable's value.
function CheckSTAT_DEBUG()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("true" "false")

    #***** Code *****
    if [ "$__STAT_DEBUG" != "true" ] && [ "$__STAT_DEBUG" != "false" ]; then
        Confecho -e "$p_file" "$p_lineno" "$__STAT_DEBUG" "__STAT_DEBUG" "${pa_correctValues[@]}"
    fi
}

# Checking the "$__STAT_ERROR" status variable's value.
function CheckSTAT_ERROR()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("" "fatal")

    #***** Code *****
    if [ -n "$__STAT_ERROR" ] && [ "$__STAT_ERROR" != "fatal" ]; then
        Confecho -e "$p_file" "$p_lineno" "$__STAT_ERROR" "__STAT_ERROR" "${pa_correctValues[@]}"
    fi
}

# Checking the "$__STAT_EXIT_CODE" status variable's value.
function CheckSTAT_EXIT_CODE()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("")

    #***** Code *****
    if ! IsInt "$__STAT_EXIT_CODE"; then
        Confecho -e "$p_file" "$p_lineno" "$__STAT_EXIT" "__STAT_EXIT" "${pa_correctValues[@]}"
    fi
}

# Checking the "$__STAT_LOG" status variable's value.
function CheckSTAT_LOG()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("true" "false")

    #***** Code *****
    if [ "$__STAT_LOG" != "true" ] && [ "$__STAT_LOG" != "false" ]; then
        Confecho -e "$p_file" "$p_lineno" "$__STAT_LOG" "__STAT_LOG" "${pa_correctValues[@]}"

    elif [ "$__STAT_LOG" = "true" ] && [ ! -f "$__BU_PROJECT_LOG_FILE_PATH" ]; then
        
        if [ ! -d "$__BU_PROJECT_LOG_DIR_PATH" ]; then

            # Even if the initialization process is still ongoing, it's possible to call an "Echo<...>()" function,
            # as the text display in this condition is managed by the "CheckProjectLogStatus()" function.
			EchoNewstep "Creating the ${__BU_COLOR_HIGHLIGHT}$__BU_PROJECT_LOG_DIR_PATH${__BU_COLOR_NEWSTEP} folder."

			mkdir -pv "$__BU_PROJECT_LOG_DIR_PATH" || { __STAT_TXT_FMT="false"; echo >&2; echo -e "${__BU_COLOR_ERROR}THE PROJECT'S TEMPORARY LOGS FOLDER CREATION FAILED" "" "$__BU_PROJECT_LOG_DIR_PATH" "$(basename "${BASH_SOURCE[0]}")" "${FUNCNAME[0]}" "$(( LINENO-2 ))"; echo >&2; exit 1; }
		fi

		echo -e "${__BU_COLOR_NEWSTEP}Creating the ${__BU_COLOR_HIGHLIGHT}$__BU_PROJECT_LOG_FILE_PATH${__BU_COLOR_NEWSTEP} file.${BU_COLOR_RESET}"

		touch "$__BU_PROJECT_LOG_FILE_PATH" || { __STAT_TXT_FMT="false"; echo >&2; echo -e "${__BU_COLOR_ERROR}THE PROJECT'S LOG FILE CREATION FAILED" "" "$__BU_PROJECT_LOG_FILE_PATH" "$(basename "${BASH_SOURCE[0]}")" "${FUNCNAME[0]}" "$(( LINENO-2 ))"; echo >&2; exit 1; }

		if CheckInitialization; then
            # shellcheck disable=SC2034
            __INIT_IS_INITALIZING="false"
        fi
		
		# Redirecting the initializer's log file content into the log file.
		HeaderBlue "INITIALIZATION PROCESS LOG OUTPUT"

		EchoNewstep "Sourced configuration files :"; for val in "${__INIT_CONFIG_FILES_PATH_ARRAY[@]}"; do EchoMsg "$val"; done; Newline
		EchoNewstep "Sourced library files : "; for val in "${__INIT_LIB_FILES_PATH_ARRAY[@]}"; do EchoMsg "$val"; done; Newline
		
		if [ -n "$__INIT_STR_ARRAY" ]; then
            EchoNewstep "Initialization log output :"; Newline

            for val in "${__INIT_STR_ARRAY[@]}"; do
                CheckProjectLogStatus "$val"
            done
		fi

		# Gathering informations about the user's operating system, allowing me to correct any bug that could occur on a precise Linux distribution.
		HeaderBlue "GETTING INFORMATIONS ABOUT USER'S SYSTEM"

		# Getting operating system family.
		EchoNewstep "Operating system family : $(DechoHighlight "$OSTYPE")"
		Newline

		# Gathering OS informations from the "/etc/os-release" file.
		EchoNewstep "Operating system general informations :"
		EchoMsg "$(cat "/etc/os-release")" "" "nodate"
		Newline

		EchoNewstep "Bash version : $(DechoHighlight "$BASH_VERSION")"
		Newline

		local v_terminfo_v="$($(ps -p $(ps -p $$ -o ppid=) o args=) -v)"

		EchoNewstep "Terminal (emulator) version : $(DechoHighlight "$v_terminfo_v")"
		Newline

		EchoSuccess "Successfully got the user's system's informations."

	fi
}

# Checking the "$__STAT_LOG_REDIRECT" status variable's value.
function CheckSTAT_LOG_REDIRECT()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("" "true" "false")

    #***** Code *****
    if [ -n "$__STAT_LOG_REDIRECT" ] && [ "$__STAT_LOG_REDIRECT" != 'log' ] && [ "$__STAT_LOG_REDIRECT" != 'tee' ]; then
        Confecho -e "$p_file" "$p_lineno" "$__STAT_LOG_REDIRECT" "__STAT_LOG_REDIRECT" "${pa_correctValues[@]}"
    fi
}

# Checking the "$__STAT_OPERATE_ROOT" status variable's value.
function CheckSTAT_OPERATE_ROOT()
{
	#***** Parameters *****
	local p_file=$1
	local p_lineno=$2

	#***** Variables *****
	local pa_correctValues=("authorized" "forbidden" "restricted")

	#***** Code *****
	if [ "$__STAT_OPERATE_ROOT" != "authorized" ] && [ "$__STAT_OPERATE_ROOT" != "forbidden" ] && [ "$__STAT_OPERATE_ROOT" != "restricted" ]; then
		Confecho -e "$p_file" "$p_lineno" "$__STAT_OPERATE_ROOT" "__STAT_OPERATE_ROOT" "${pa_correctValues[@]}"
	fi
}

# Checking the "$__STAT_TIME_TXT" status variable's value.
function CheckSTAT_TIME_TXT()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("${__BU_COLOR_ORANGE}An integer or a floating number")

    #***** Code *****
    # If the status variable's value is not a float or an integer.
    if ! IsFloatInt "$__STAT_TIME_TXT"; then
        Confecho -e "$p_file" "$p_lineno" "$__STAT_TIME_TXT" "__STAT_TIME_TXT" "${pa_correctValues[@]}" >&2
    fi
}

# Checking the "$__STAT_TXT_FMT" status variable's value.
function CheckSTAT_TXT_FMT()
{
    #***** Parameters *****
    p_file=$1
    p_lineno=$2

    #***** Variables *****
    local pa_correctValues=("true" "false")

    #***** Code *****
    if [ "$__STAT_TXT_FMT" != "true" ] && [ "$__STAT_TXT_FMT" != "false" ]; then
        Confecho -e "$p_file" "$p_lineno" "$__STAT_TXT_FMT" '__STAT_TXT_FMT' "${pa_correctValues[@]}"
    fi
}
# Checking the "$__STAT_USER_OS" status variable's value.
# This function is empty now, as the OS handling is still in work.
function CheckSTAT_USER_OS()
{
    #***** Parameters *****
    local p_file=$1
    local p_lineno=$2

    #***** Code *****
    return
}


# Checking all the project's status variables values if multiple values had been modified.
function CheckProjectStatusVars()
{
    #***** Parameters *****
    local p_file=$1error
    local p_lineno=$2

    #***** Code *****
    # Processing first the "STAT_LOG_REDIRECT" variable, to make sure the following error messages will be correctly displayed if another error happened.
    CheckSTAT_LOG_REDIRECT  "$p_file" "$p_lineno"
    CheckSTAT_DEBUG         "$p_file" "$p_lineno"
    CheckSTAT_ERROR         "$p_file" "$p_lineno"
    CheckSTAT_TXT_FMT       "$p_file" "$p_lineno"
    CheckSTAT_EXIT_CODE     "$p_file" "$p_lineno"
	CheckSTAT_OPERATE_ROOT  "$p_file" "$p_lineno"
    CheckSTAT_LOG           "$p_file" "$p_lineno"
	CheckSTAT_OPERATE_ROOT  "$p_file" "$p_lineno"
    CheckSTAT_TIME_TXT      "$p_file" "$p_lineno"
}

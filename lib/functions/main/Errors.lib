#!/usr/bin/env bash

# ----------------------
# SCRIPT'S INFORMATIONS

# Name          : Errors.lib
# Module        : Main
# Description   : Errors handling functions.
# Author(s)     : Dimitri Obeid
# Version       : 

# ----------------------
# SHELLCHECK GLOBAL DISABLER :

# Add a coma after each warning code to disable multiple warnings at one go.
# DO NOT PUT A COMA AFTER A SHELLCHECK CODE IF THERE'S NO OTHER SHELLCHECK CODE FOLLOWING IT, OR ELSE SHELLCHECK WILL RETURN ERRORS DURING THE DEBUGGING PROCESS !!!

# shellcheck disable=SC2154

# ----------------------
# DO NOT EXECUTE THIS SCRIPT DIRECTLY, instead, just source it by calling the "$__BU_MAIN_FUNCTIONS_FILES_PATH" array in the initializer file.

# /////////////////////////////////////////////////////////////////////////////////////////////// #

# Preventing the direct execution of this file, as this script is not meant to be directly executed, but sourced.
if [ "${0##*/}" == "${BASH_SOURCE[0]##*/}" ]; then
    echo -e "WARNING !" >&2; echo >&2
    echo -e "This shell script (${BASH_SOURCE[0]}) is not meant to be executed directly !" >&2
    echo -e "Use this script only by sourcing it in your project script." >&2; echo >&2

    exit 1
fi

# ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; #

#################################### DEFINING LIBRARY FUNCTIONS ###################################

# /////////////////////////////////////////////////////////////////////////////////////////////// #

#### ERRORS HANDLING FUNCTIONS

## CLASSIC ERRORS HANDLING

# Saving time when displaying a newline, an error message and an exit or a return value.

# WARNING ! DO NOT CALL ANY FUNCTION THAT CALL THIS FUNCTION DIRECTLY OR INDIRECTLY HERE,
# OR THE SCRIPT WILL LOOP FOREVER IN CASE OF AN ERROR DURING THIS FUNCTION CALL !!!
function HandleSmallErrors()
{
    #***** Parameters *****
    local p_type=$1         # Type of message to display ('E' = EchoError; 'W' = EchoWarning)
    local p_string=$2       # String to display.
    local p_return=$3       # Exit or return status ('E' = exit; 'R' = return).
    local p_cpls=$4         # Enable the safe text printing mode.

    #***** Variables *****
    local v_advise="Please don't forget to pass a type of message to display as first argument ('E' = EchoError; 'W' = EchoWarning)"

    if [ "${p_cpls^^}" = 'CPLS' ]; then
        if [ "$__BU_MAIN_STAT_ECHO" = 'false' ]; then
            local v_BU_STAT_ECHO_old="$__BU_MAIN_STAT_ECHO"; ChangeSTAT_ECHO 'true' "$(basename "${BASH_SOURCE[0]}")" "$LINENO"
        fi
    fi

    #***** Code *****
    Newline >&2;

    if [ "$p_type" = 'E' ]; then EchoError "$p_string" '' ''
    elif [ "$p_type" = 'W' ]; then EchoWarning "$p_string" '' ''

    # If no type of message to displays is passed as first argument, the script will choose between one of the accepted types.
    else
        if [ "$(( RANDOM%2 ))" = "0" ]; then
            EchoError "$p_string    | ${__BU_MAIN_COLOR_RESET}$v_advise" '' ''
        else
            EchoWarning "$p_string  | ${__BU_MAIN_COLOR_RESET}$v_advise" '' ''
        fi
    fi

    Newline >&2

    # As the "EchoWarning()" function will be called in case of a missing return or exit code (normally passed as second argument),
    # it's better to reset the value of the "$__BU_MAIN_STAT_ECHO" status variable condition per condition.
    if [ "${p_return^^}" = 'R' ]; then
        if [ "$v_BU_STAT_ECHO_old" = "true" ]; then __BU_MAIN_STAT_ECHO='false'; fi

        return 1

    elif [ "${p_return^^}" = 'E' ]; then
        if [ "$v_BU_STAT_ECHO_old" = "true" ]; then __BU_MAIN_STAT_ECHO='false'; fi

        ExitError '1'

    else 
        EchoWarning "${__BU_MAIN_COLOR_HIGHLIGHT}${FUNCNAME[0]}${__BU_MAIN_COLOR_WARNING} --> Warning : bad exit or return code given as second argument !"; ExitError '1'

        if [ "$v_BU_STAT_ECHO_old" = "true" ]; then __BU_MAIN_STAT_ECHO='false'; fi
    fi
}

# -----------------------------------------------

## EXIT HANDLING

# Handling exit command from sourced files, as it's impossible to properly exit the script from these.
function ExitError()
{
    if [[ "$1" =~ [0-9] ]]; then
        exit "$1"; kill "$$"
    else
        EchoWarning "$(DechoHighlight "${FUNCNAME[0]}()") --> Warning : unexpected exit code passed as argument."

        kill "$$"
    fi
}

# -----------------------------------------------

## SCRIPT'S ERRORS HANDLING

# "HandleErrors()" function --> Handling file name presence.
function HandleErrors_File()        { if [ -z "$1" ]; then if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then DechoHighlight "<no specified file>"; else DechoHighlight "$__BU_MAIN_MSG_ERRORS_HandleErrors_File_NO_FILE"; fi; else DechoHighlight "$1"; fi; }

# "HandleErrors()" function --> Handling function name presence.
function HandleErrors_Function()    { if [ -z "$1" ]; then if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then DechoHighlight "<no specified function>"; else DechoHighlight "$__BU_MAIN_MSG_ERRORS_HandleErrors_Function_NO_FUNCTION"; fi; else DechoHighlight "$1"; fi; }

# "HandleErrors()" function --> Handling line number presence.
function HandleErrors_Line()        { if [ -z "$1" ]; then if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then DechoHighlight "<no specified line>"; else DechoHighlight "$__BU_MAIN_MSG_ERRORS_HandleErrors_Line_NO_LINE"; fi; else DechoHighlight "$1"; fi; }

# Handling command outputs.
# Featured functions and files from the "basis" category :
#   - 
function HandleErrors()
{
	#***** Parameters *****
	local p_returnCode=$1      # Return code of the last command executed. If you didn't launched any command before calling this function, you can pass any number different of '0' as first argument.
	local p_errorString=$2     # String of the type of error to display.
	local p_adviceString=$3    # String of characters displaying a tip to direct the user to the best solution to apply in case of a problem.
    local p_badValue=$4        # Incorrect value which caused the error.
	local p_file=$5            # The name of the file where the error occured.
	local p_function=$6        # The name of the function where the error occured.
	local p_lineno=$7          # Line on which the error message occured (obtained in a very simple way by calling the POSIX environment variable "$LINENO").

    #***** Variables *****
    if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then
        local v_hdrString;
            v_hdrString="$(echo -ne "IN $(HandleErrors_File "$p_file") FILE, FUNCTION $(HandleErrors_Function "$p_function"), LINE $(HandleErrors_Line "$p_lineno") -->")"
    else
        local v_hdrString;
            v_hdrString="$(echo -ne "$__BU_MAIN_MSG_ERRORS_HandleErrors_HDR_STRING")"
    fi

	# ***** Code *****
	CheckSTAT_ERROR "$(basename "${BASH_SOURCE[0]}")" "$LINENO"

	if [ "$p_returnCode" -eq 0 ]; then
        return 0
    else
        # -------- PART 1 : MANAGING THE CALL OF THIS "HandleErrors()" FUNCTION IF THIS "HandleErrors()" FUNCTION IS CALLED IN A FUNCTION CALLED BY THIS "HandleErrors()" FUNCTION

        # If the function needs to be called in the "CheckProjectLogStatus()" function,
        # this status variable's value MUST be set at "true", or else the script will loop forever.

        # WARNING : DO NOT call a text formatting function to format something else than the text color, or else the script will loop forever.

        if [ "$__BU_MAIN_STAT_ECHO" = "true" ]; then

            # Drawing an extra line to differenciate the message below from the rest of the error messages.
            EchoMsg "$(DrawLine "$__BU_MAIN_COLOR_ERROR" "$__BU_MAIN_TXT_PRINT_HEADER_LINE")" '' 'nodate'

            if [ -n "$__BU_MAIN_STAT_ERROR" ] && [ "$__BU_MAIN_STAT_ERROR" = "fatal" ]; then
                if [ "$__BU_MAIN_STAT_INITIALIZING" = 'false' ]; then
                    if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "A FATAL ERROR OCCURED DURING A TEST IN THE $(DechoHighlight "CheckProjectLogStatus") FUNCTION OR ANOTHER TEST WHERE THE MENTIONNED FUNCTION CANNOT BE CALLED !"
                    else EchoError ""; fi
                else
                    if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "A FATAL ERROR OCCURED DURING THE $(DechoHighlight "$__BU_MAIN_PROJECT_NAME")'S PROJECT INITIALIZATION"
                    else EchoError ""; fi
                fi
            else
                if [ "$__BU_MAIN_STAT_INITIALIZING" = 'false' ]; then
                    if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "AN ERROR OCCURED DURING A TEST IN THE $(DechoHighlight "CheckProjectLogStatus") FUNCTION OR ANOTHER TEST WHERE THE MENTIONNED FUNCTION CANNOT BE CALLED !"
                    else EchoError ""; fi
                else
                    if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "AN ERROR OCCURED DURING THE $(DechoHighlight "$__BU_MAIN_PROJECT_NAME")'S PROJECT INITIALIZATION"
                    else EchoError ""; fi
                fi
            fi
        fi


        # -------- PART 2 : PRINTING THE HEADER

        # Redirecting the log messages to the terminal, to show them to the user. 
        if [ "$__BU_MAIN_STAT_LOG_REDIRECT" = "log" ]; then
            local v_log_old="true"; __BU_MAIN_STAT_LOG_REDIRECT="tee"; CheckSTAT_LOG_REDIRECT "$(basename "${BASH_SOURCE[0]}")" "$LINENO"
        fi

        if [ "$__BU_MAIN_STAT_ERROR" = "fatal" ]; then
            if CheckStatIsInitializing; then
                if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then InitializerAddInitStrArrayVal "$(HeaderRed "$v_hdrString FATAL ERROR : $p_errorString")" >&2
                else InitializerAddInitStrArrayVal "$(HeaderRed "$v_hdrString $__BU_MAIN_MSG_ERRORS_HandleErrors_ : $p_errorString")" >&2; fi
            else
                if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then HeaderRed "$v_hdrString FATAL ERROR : $p_errorString" >&2
                else HeaderRed "$v_hdrString $__BU_MAIN_MSG_ERRORS_HandleErrors_ : $p_errorString" >&2; fi
            fi
        else
            if CheckStatIsInitializing; then
                if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then InitializerAddInitStrArrayVal "$(HeaderRed "$v_hdrString ERROR : $p_errorString")" >&2
                else InitializerAddInitStrArrayVal "$(HeaderRed "$v_hdrString $__BU_MAIN_MSG_ERRORS_HandleErrors_ : $p_errorString")" >&2; fi
            else
                if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then HeaderRed "$v_hdrString ERROR : $p_errorString" >&2
                else HeaderRed "$v_hdrString $__BU_MAIN_MSG_ERRORS_HandleErrors_ : $p_errorString" >&2; fi
            fi
        fi

        Newline >&2


        # -------- PART 3 : GIVING AN ADVICE ABOUT THE ORIGIN OF THE ERROR TO THE USER/DEVELOPPER

        if [ -z "$p_adviceString" ]; then
            if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "No advice to give."; Newline >&2; else EchoError "$__BU_MAIN_MSG_ERRORS_HandleErrors_"; fi
        else
            if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "$(DechoHighlight "Advice") : $p_adviceString" >&2; Newline >&2; else EchoError ""; fi
        fi

        if [ -z "$p_badValue" ]; then
            if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "Value(s) that caused this error : $(DechoOrange 'no value') OR $(DechoOrange 'an unknown error')"; Newline >&2
            else EchoError "$__BU_MAIN_MSG_ERRORS_HandleErrors_"; fi
        else
            if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "Value(s) that caused this error : $(DechoHighlight "$p_badValue")"; Newline >&2; else EchoError "$__BU_MAIN_MSG_ERRORS_HandleErrors_"; fi
        fi

        if [ "$__BU_MAIN_STAT_ERROR" = "fatal" ]; then
            if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then EchoError "Stopping the execution of $(DechoHighlight "$(basename "$0")")."; Newline >&2; else EchoError "$__BU_MAIN_MSG_ERRORS_HandleErrors_"; fi
            ExitError "1"
        else
            # Calling the function that processes the given answer.
            CaseRead_HandleErrors
        fi

        if [ "$__BU_MAIN_STAT_ECHO" = "true" ]; then
            if [ -f "$__BU_MAIN_PROJECT_LOG_FILE_PATH" ]; then
                EchoWarning "" 2>&1 | tee -a "$__BU_MAIN_PROJECT_LOG_FILE_PATH" ||
                {
                    if [ "$__BU_MAIN_STAT_TRANSLATED" = 'false' ]; then
                        HandleSmallErrors "Unable to write in the $(DechoHighlight "$__BU_MAIN_PROJECT_LOG_FILE_PATH") projectlog file from the $(DechoHighlight "${FUNCNAME[0]}()") function" 'R' 'CPLS'
                    else
                        HandleSmallErrors "$__BU_MAIN_MSG_ERRORS_HandleErrors_" 'R' 'CPLS'
                    fi
                }
            fi
        fi

        if [ "$v_log_old" = "true" ]; then
            __BU_MAIN_STAT_LOG_REDIRECT="log"; CheckSTAT_LOG_REDIRECT "$(basename "${BASH_SOURCE[0]}")" "$LINENO"
        fi
    fi

    return 1
}

# -----------------------------------------------
